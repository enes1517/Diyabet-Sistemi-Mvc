@using System.Data
@model dynamic
@{
    ViewData["Title"] = "Hasta Paneli";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Kullanıcı Bilgileri -->
<h3>Kullanıcı Bilgileri</h3>
@if (ViewBag.Kullanici != null)
{
    <table class="table table-bordered">
        <tr><th>Ad</th><td>@ViewBag.Kullanici["Ad"]</td></tr>
        <tr><th>Soyad</th><td>@ViewBag.Kullanici["Soyad"]</td></tr>
    </table>
}
else
{
    <p class="text-danger">Kullanıcı bilgileri yüklenemedi.</p>
}

<!-- Hasta Bilgileri -->
<h3>Hasta Bilgileri</h3>
@if (ViewBag.Hasta != null)
{
    <table class="table table-bordered">
        <tr><th>Boy</th><td>@(!DBNull.Value.Equals(ViewBag.Hasta["Boy"]) ? $"{ViewBag.Hasta["Boy"]} cm" : "Belirtilmemiş")</td></tr>
        <tr><th>Kilo</th><td>@(!DBNull.Value.Equals(ViewBag.Hasta["Kilo"]) ? $"{ViewBag.Hasta["Kilo"]} kg" : "Belirtilmemiş")</td></tr>
    </table>
}
else
{
    <p class="text-danger">Hasta bilgileri yüklenemedi.</p>
}

<!-- Genel Kan Şekeri Ortalaması -->
<h3>Genel Kan Şekeri Ortalaması</h3>
@if (ViewBag.AverageBloodSugar != null)
{
    <p><strong>Ortalama:</strong> @ViewBag.AverageBloodSugar mg/dL</p>
    <p><strong>İnsülin Önerisi:</strong> @ViewBag.InsulinRecommendation</p>
}
else
{
    <p class="text-info">Henüz geçerli saatlerde ölçüm bulunmamaktadır. Lütfen önerilen saatlerde (07:00-08:00, 13:00-14:00, 15:00-16:00, 18:00-19:00, 22:00-23:00) ölçüm yapınız.</p>
}
<p class="text-muted">
    Not: Ortalama, tüm geçerli saatlerde yapılan ölçümler kullanılarak hesaplanır. Kritik seviyelerde (<70 mg /dL veya>200 mg/dL) doktorunuza otomatik uyarı gönderilir.
</p>

<!-- Kan Şekeri Grafiği -->
<h3>Kan Şekeri Grafiği</h3>
@if (ViewBag.ChartData != null && ViewBag.ChartData.Count > 0)
{
    <canvas id="bloodSugarChart" style="max-height:400px;"></canvas>
}
else
{
    <p class="text-info">Grafik için yeterli kan şekeri verisi bulunmamaktadır.</p>
}

<!-- Diyet ve Egzersiz Uyum Yüzdeleri -->
<h3>Diyet ve Egzersiz Uyum Yüzdeleri</h3>
<div class="row">
    <div class="col-md-6">
        <h5>Diyet Uyum Oranı</h5>
        <div class="progress">
            <div class="progress-bar bg-success" role="progressbar" style="width: @ViewBag.DiyetAdherence%" aria-valuenow="@ViewBag.DiyetAdherence" aria-valuemin="0" aria-valuemax="100">
                %@ViewBag.DiyetAdherence
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <h5>Egzersiz Uyum Oranı</h5>
        <div class="progress">
            <div class="progress-bar bg-info" role="progressbar" style="width: @ViewBag.EgzersizAdherence%" aria-valuenow="@ViewBag.EgzersizAdherence" aria-valuemin="0" aria-valuemax="100">
                %@ViewBag.EgzersizAdherence
            </div>
        </div>
    </div>
</div>

<!-- Kan Şekeri Kayıtları -->
<h3>Kan Şekeri Kayıtları</h3>
<a asp-action="KanSekeriEkle" class="btn btn-primary mb-3">Yeni Ölçüm Ekle</a>
@if (ViewBag.KanSekeri != null && ViewBag.KanSekeri.Rows.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Ölçüm Değeri (mg/dL)</th>
                <th>Tarih</th>
                <th>Saat</th>
                <th>Ölçüm Türü</th>
                <th>Ortalamaya Dahil</th>
                <th>Uyarı Durumu</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in ViewBag.KanSekeri.Rows)
            {
                TimeSpan olcumSaati = TimeSpan.Parse(row["OlcumSaati"].ToString());
                bool isValidTime = (olcumSaati >= TimeSpan.Parse("07:00:00") && olcumSaati <= TimeSpan.Parse("08:00:00")) ||
                (olcumSaati >= TimeSpan.Parse("13:00:00") && olcumSaati <= TimeSpan.Parse("14:00:00")) ||
                (olcumSaati >= TimeSpan.Parse("15:00:00") && olcumSaati <= TimeSpan.Parse("16:00:00")) ||
                (olcumSaati >= TimeSpan.Parse("18:00:00") && olcumSaati <= TimeSpan.Parse("19:00:00")) ||
                (olcumSaati >= TimeSpan.Parse("22:00:00") && olcumSaati <= TimeSpan.Parse("23:00:00"));
                decimal olcumDegeri = Convert.ToDecimal(row["OlcumDegeri"]);
                string uyariDurumu = olcumDegeri < 70 ? "Hipoglisemi Riski (Doktor Uyarılmış)" :
                olcumDegeri > 200 ? "Hiperglisemi (Doktor Uyarılmış)" :
                olcumDegeri >= 111 && olcumDegeri <= 150 ? "Orta Yüksek Seviye" :
                olcumDegeri >= 151 && olcumDegeri <= 200 ? "Yüksek Seviye" :
                "Normal Seviye";
                if (!isValidTime)
                {
                    uyariDurumu = "Geçersiz Zaman";
                }
                <tr>
                    <td>@row["OlcumDegeri"]</td>
                    <td>@Convert.ToDateTime(row["OlcumTarihi"]).ToString("dd.MM.yyyy")</td>
                    <td>@row["OlcumSaati"]</td>
                    <td>@row["OlcumTuru"]</td>
                    <td>
                        <span class="badge @(isValidTime ? "bg-success" : "bg-warning")">@(isValidTime ? "Evet" : "Hayır")</span>
                    </td>
                    <td>
                        <span class="badge @(uyariDurumu.Contains("Hipoglisemi") || uyariDurumu.Contains("Hiperglisemi") ? "bg-danger" : uyariDurumu.Contains("Geçersiz") ? "bg-warning" : "bg-success")">@uyariDurumu</span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-info">Kan şekeri kaydı bulunmamaktadır.</p>
}

<!-- İnsülin Uygulamaları -->
<h3>İnsülin Uygulamaları</h3>
<p class="text-muted">Geçmiş insülin dozlarınızı aşağıdaki tarih aralığını seçerek görüntüleyebilirsiniz.</p>
<form asp-action="Index" method="get" class="mb-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label for="startDate" class="form-label">Başlangıç Tarihi</label>
            <input type="date" name="startDate" id="startDate" class="form-control" value="@(ViewBag.StartDate != null ? ((DateTime)ViewBag.StartDate).ToString("yyyy-MM-dd") : DateTime.Today.AddDays(-7).ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-4">
            <label for="endDate" class="form-label">Bitiş Tarihi</label>
            <input type="date" name="endDate" id="endDate" class="form-control" value="@(ViewBag.EndDate != null ? ((DateTime)ViewBag.EndDate).ToString("yyyy-MM-dd") : DateTime.Today.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary me-2">Filtrele</button>
            <a href="@Url.Action("Index")" class="btn btn-secondary">Filtreyi Temizle</a>
        </div>
    </div>
</form>
@if (ViewBag.Insulin != null && ViewBag.Insulin.Rows.Count > 0)
{
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Doz</th>
                <th>Tarih</th>
                <th>Saat</th>
                <th>Ortalama Kan Şekeri</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in ViewBag.Insulin.Rows)
            {
                <tr>
                    <td>@row["Doz"]</td>
                    <td>@Convert.ToDateTime(row["UygulamaTarihi"]).ToString("dd.MM.yyyy")</td>
                    <td>@row["UygulamaSaati"]</td>
                    <td>@row["OrtalamaKanSekeri"]</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-info">İnsülin uygulama kaydı bulunmamaktadır.</p>
}

<!-- Diyet Kayıtları -->
<h3>Diyet Kayıtları</h3>
@if (ViewBag.Diyet != null && ViewBag.Diyet.Rows.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Diyet Türü</th>
                <th>Tarih</th>
                <th>Durum</th>
                <th>İşlem</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in ViewBag.Diyet.Rows)
            {
                bool uygulandiMi = Convert.ToBoolean(row["UygulandiMi"]);
                int diyetId = Convert.ToInt32(row["DiyetID"]);
                <tr>
                    <td>@row["TurAdi"]</td>
                    <td>@Convert.ToDateTime(row["Tarih"]).ToString("dd.MM.yyyy")</td>
                    <td>@(uygulandiMi ? "Uygulandı" : "Uygulanmadı")</td>
                    <td>
                        <form asp-action="DiyetGuncelle" method="post" style="display:inline;">
                            <input type="hidden" name="diyetId" value="@diyetId" />
                            <input type="hidden" name="uygulandiMi" value="true" />
                            <button type="submit" class="btn btn-sm @(uygulandiMi ? "btn-outline-success" : "btn-success")" @(uygulandiMi ? "disabled" : "")>Uygulandı</button>
                        </form>
                        <form asp-action="DiyetGuncelle" method="post" style="display:inline;">
                            <input type="hidden" name="diyetId" value="@diyetId" />
                            <input type="hidden" name="uygulandiMi" value="false" />
                            <button type="submit" class="btn btn-sm @(uygulandiMi ? "btn-danger" : "btn-outline-danger")" @(!uygulandiMi ? "disabled" : "")>Uygulanmadı</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-info">Diyet kaydı bulunmamaktadır.</p>
}

<!-- Egzersiz Kayıtları -->
<h3>Egzersiz Kayıtları</h3>
@if (ViewBag.Egzersiz != null && ViewBag.Egzersiz.Rows.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Egzersiz Türü</th>
                <th>Tarih</th>
                <th>Durum</th>
                <th>İşlem</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in ViewBag.Egzersiz.Rows)
            {
                bool yapildiMi = Convert.ToBoolean(row["YapildiMi"]);
                int egzersizId = Convert.ToInt32(row["EgzersizID"]);
                <tr>
                    <td>@row["TurAdi"]</td>
                    <td>@Convert.ToDateTime(row["Tarih"]).ToString("dd.MM.yyyy")</td>
                    <td>@(yapildiMi ? "Yapıldı" : "Yapılmadı")</td>
                    <td>
                        <form asp-action="EgzersizGuncelle" method="post" style="display:inline;">
                            <input type="hidden" name="egzersizId" value="@egzersizId" />
                            <input type="hidden" name="yapildiMi" value="true" />
                            <button type="submit" class="btn btn-sm @(yapildiMi ? "btn-outline-success" : "btn-success")" @(yapildiMi ? "disabled" : "")>Yapıldı</button>
                        </form>
                        <form asp-action="EgzersizGuncelle" method="post" style="display:inline;">
                            <input type="hidden" name="egzersizId" value="@egzersizId" />
                            <input type="hidden" name="yapildiMi" value="false" />
                            <button type="submit" class="btn btn-sm @(yapildiMi ? "btn-danger" : "btn-outline-danger")" @(!yapildiMi ? "disabled" : "")>Yapılmadı</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-info">Egzersiz kaydı bulunmamaktadır.</p>
}

<!-- Belirti Kayıtları -->
<h3>Belirti Kayıtları</h3>
@if (ViewBag.Belirtiler != null && ViewBag.Belirtiler.Rows.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Belirti</th>
                <th>Tarih</th>
                <th>Şiddet</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in ViewBag.Belirtiler.Rows)
            {
                <tr>
                    <td>@row["BelirtiAdi"]</td>
                    <td>@Convert.ToDateTime(row["Tarih"]).ToString("dd.MM.yyyy")</td>
                    <td>@row["Siddet"]</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-info">Belirti kaydı bulunmamaktadır.</p>
}

<!-- Uyarılar -->
<h3>Uyarılar</h3>
@if (ViewBag.Uyarilar != null && ViewBag.Uyarilar.Rows.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Uyarı Türü</th>
                <th>Mesaj</th>
                <th>Tarih</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row in ViewBag.Uyarilar.Rows)
            {
                <tr>
                    <td>@row["UyariTuru"]</td>
                    <td>@row["UyariMesaji"]</td>
                    <td>@Convert.ToDateTime(row["UyariTarihi"]).ToString("dd.MM.yyyy HH:mm")</td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p class="text-success">Şu anda aktif uyarı yok.</p>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var ctx = document.getElementById('bloodSugarChart').getContext('2d');
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(ViewBag.ChartLabels)),
                    datasets: [{
                        label: 'Kan Şekeri (mg/dL)',
                        data: @Html.Raw(Json.Serialize(ViewBag.ChartData)),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tarih ve Saat'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Kan Şekeri (mg/dL)'
                            },
                            beginAtZero: false
                        }
                    }
                }
            });
        });
    </script>
}